<!DOCTYPE html>
{% load static %}
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>{{ post.title }} - 정책 제안</title>
  <style>
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 400px;
      color: black;
    }
    .modal-content textarea {
      width: 100%;
      height: 60px;
      margin-bottom: 10px;
    }
    .modal-content h3 {
      margin-top: 0;
    }
    .modal.show {
      display: flex;
    }
  </style>
</head>
<body>
<a href="{% url 'proposals:home' %}">← 정책 제안 홈으로</a>
<h2>{{ post.title }}에 대하여 새로운 정책을 제안해 주세요</h2>
<hr>

<h3>투표 결과</h3>
<p>Q. {{ post.question }}</p>
<p>결과: {{ post.result_choice }} ({{ post.result_percent }}%)</p>
<p>
  <a href="{% url 'community:detail' post.community_post.id %}">
    {{ post.community_post.title }}
  </a>
</p>
<p>
  라는 논제에 대한 국민 투표 결과, <strong>{{ post.result_choice }}</strong>는 의견이 다수를 차지하며 종료되었습니다.
</p>

<div style="display:flex; justify-content:space-between; align-items:center;">
  <div><a href="{% url 'proposals:detail_post_like' post.id %}">❤️ {{ post.liked.count }}</a></div>
  <div>💬 {{ post.proposal_comments.count }}</div>
  <div>
    {% if request.user in post.scrapped.all %}
    <a style="color: #a57bff;" href="{% url 'proposals:detail_post_scrap' post.id %}">스크랩</a>
    {% else %}
    <a style="color: #000;" href="{% url 'proposals:detail_post_scrap' post.id %}">스크랩</a>
    {% endif %}
  </div>
</div>

<hr>
<!-- 정책 제안 버튼 -->
<button onclick="openModal()">정책 제안하기</button>

<!-- 모달 팝업 폼 -->
<div id="proposalModal" class="modal">
  <div class="modal-content">
    <h3>정책 제안하기</h3>
    <form method="post" action="{% url 'proposals:detail_comment_create' post.id %}">
      {% csrf_token %}
      <label>제안 제목</label><br>
      <textarea name="title" required></textarea><br>
      <label>현황 및 문제점</label><br>
      <textarea name="problem" required></textarea><br>
      <label>개선 방안</label><br>
      <textarea name="solution" required></textarea><br>
      <label>기대 효과</label><br>
      <textarea name="effect" required></textarea><br>
      <button type="submit">제안하기</button>
      <button type="button" onclick="closeModal()">닫기</button>
    </form>
  </div>
</div>

<hr>
<h3>제안 ({{ post.proposal_comments.count }}건)</h3>
{% for comment in post.proposal_comments.all %}
  <div id="comment_{{ comment.id }}" style="border-top:1px solid #000; padding:10px 0;">
    <strong>{{ comment.user.username }}:</strong><br>
    <p><strong>{{ comment.title }}</strong></p>
    <p><b>현황 및 문제점:</b> {{ comment.problem }}</p>
    <p><b>개선 방안:</b> {{ comment.solution }}</p>
    <p><b>기대 효과:</b> {{ comment.effect }}</p>

    <p>
      {{ comment.created_at|date:"Y-m-d H:i" }}
      <button onclick="toggleReply({{ comment.id }})">💬 대댓글 ({{ comment.proposal_replies.count }})</button>
      <a href="{% url 'proposals:detail_comment_like' post.id comment.id %}">❤️ {{ comment.liked.count }}</a>
      
    </p>

    <div id="reply-section-{{ comment.id }}" style="display:none;">
      {% for reply in comment.proposal_replies.all %}
        <div id="reply_{{ reply.id }}">
          <strong>{{ reply.user.username }}{% if reply.user == comment.user %} (글쓴이){% endif %}</strong>
          <p>{{ reply.content }}</p>
          <small>{{ reply.created_at|date:"Y-m-d H:i" }}</small>
          <a href="{% url 'proposals:detail_reply_like' post.id comment.id reply.id %}">❤️ {{ reply.liked.count }}</a>
        </div>
      {% empty %}
        <p>대댓글이 없습니다.</p>
      {% endfor %}

      <form method="post" action="{% url 'proposals:detail_reply_create' post.id comment.id %}">
        {% csrf_token %}
        <textarea name="content" placeholder="대댓글을 입력하세요..." style="width:100%; height:60px;"></textarea><br>
        <button type="submit">등록</button>
      </form>
    </div>
  </div>
{% empty %}
  <p>아직 제안이 없습니다.</p>
{% endfor %}

<script>
  function toggleReply(commentId) {
    const el = document.getElementById('reply-section-' + commentId);
    el.style.display = el.style.display === 'block' ? 'none' : 'block';
  }

  function openModal() {
    document.getElementById('proposalModal').classList.add('show');
  }

  function closeModal() {
    document.getElementById('proposalModal').classList.remove('show');
  }
</script>
</body>
</html>
