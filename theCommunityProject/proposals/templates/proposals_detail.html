<!DOCTYPE html>
{% load static %}
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>{{ post.title }} - ì •ì±… ì œì•ˆ</title>
  <style>
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 400px;
      color: black;
    }

    .modal-content textarea {
      width: 100%;
      height: 60px;
      margin-bottom: 10px;
    }

    .modal-content h3 {
      margin-top: 0;
    }

    .modal.show {
      display: flex;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1.5rem;
    }

    .card {
      background-color: #1f1f1f;
      padding: 1rem;
      border-radius: 10px;
      color: white;
      transition: transform 0.2s ease;
    }

    .article-thumbnail {
      width: 120px;
      height: 120px;
      border-radius: 8px;
      background-color: #ccc;
      object-fit: cover;
    }
  </style>
</head>

<body>

  {% if messages %}
  <div>
    {% for message in messages %}
    <p style="color:red;">{{ message }}</p>
    {% endfor %}
  </div>
  {% endif %}

  <a href="{% url 'proposals:home' %}">â† ì •ì±… ì œì•ˆ í™ˆìœ¼ë¡œ</a>
  <h2>{{ post.title }}ì— ëŒ€í•´ì„œ ìƒˆë¡œìš´ ì •ì±…ì„ ì œì•ˆí•´ ì£¼ì„¸ìš”</h2>
  <hr>

  <h3>íˆ¬í‘œ ê²°ê³¼</h3>
  <p>Q. {{ post.question }}</p>
  <p>ê²°ê³¼: {{ post.result_choice }} ({{ post.result_percent }}%)</p>
  <p>
    <a href="{% url 'community:detail' post.community_post.id %}">
      {{ post.community_post.title }}
    </a>
  </p>
  <p>
    ë¼ëŠ” ë…¼ì œì— ëŒ€í•œ êµ­ë¯¼ íˆ¬í‘œ ê²°ê³¼, <strong>{{ post.result_choice }}</strong>ëŠ” ì˜ê²¬ì´ ë‹¤ìˆ˜ë¥¼ ì°¨ì§€í•˜ë©° ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
  </p>

  <div style="display:flex; justify-content:space-between; align-items:center;">
    <div><a href="{% url 'proposals:detail_post_like' post.id %}">â¤ï¸ {{ post.liked.count }}</a></div>
    <div>ğŸ’¬ {{ post.proposal_comments.count }}</div>
    <div>
      {% if request.user in post.scrapped.all %}
      <a style="color: #a57bff;" href="{% url 'proposals:detail_post_scrap' post.id %}">ìŠ¤í¬ë©</a>
      {% else %}
      <a style="color: #000;" href="{% url 'proposals:detail_post_scrap' post.id %}">ìŠ¤í¬ë©</a>
      {% endif %}
    </div>
    <div><button onclick="copyCurrentUrl()">ê³µìœ </button></div>
  </div>

  <hr>
  <!-- ì •ì±… ì œì•ˆ ë²„íŠ¼ -->
  <button onclick="openProposalModal()">ì •ì±… ì œì•ˆí•˜ê¸°</button>

  <!-- ì •ì±… ì œì•ˆ ëª¨ë¸ -->
  <div id="proposalModal" class="modal">
    <div class="modal-content">
      <h3>ì •ì±… ì œì•ˆí•˜ê¸°</h3>
      <form method="post" action="{% url 'proposals:detail_comment_create' post.id %}">
        {% csrf_token %}
        <label>ì œì•ˆ ì œëª©</label><br>
        <textarea name="title" required></textarea><br>
        <label>í˜„í™© ë° ë¬¸ì œì </label><br>
        <textarea name="problem" required></textarea><br>
        <label>ê°œì„  ë°©ì•ˆ</label><br>
        <textarea name="solution" required></textarea><br>
        <label>ê¸°ëŒ€ íš¨ê³¼</label><br>
        <textarea name="effect" required></textarea><br>
        <button type="submit">ì œì•ˆí•˜ê¸°</button>
        <button type="button" onclick="closeProposalModal()">ë‹«ê¸°</button>
      </form>
    </div>
  </div>

  <!-- ìˆ˜ì • ëª¨ë¸ -->
  <!-- <div id="editCommentModal" class="modal">
    <div class="modal-content">
      <h3>ì •ì±… ì œì•ˆ ìˆ˜ì •</h3>
      <form method="post" id="editCommentForm">
        {% csrf_token %}
        <label>ì œì•ˆ ì œëª©</label><br>
        <textarea name="title" id="editCommentTitle" required></textarea><br>
        <label>í˜„í™© ë° ë¬¸ì œì </label><br>
        <textarea name="problem" id="editCommentProblem" required></textarea><br>
        <label>ê°œì„  ë°©ì•ˆ</label><br>
        <textarea name="solution" id="editCommentSolution" required></textarea><br>
        <label>ê¸°ëŒ€ íš¨ê³¼</label><br>
        <textarea name="effect" id="editCommentEffect" required></textarea><br>
        <button type="submit">ìˆ˜ì • ì™„ë£Œ</button>
        <button type="button" onclick="closeEditModal()">ë‹«ê¸°</button>
      </form>
    </div>
  </div> -->

  <div id="linkModal" class="modal">
    <div class="modal-content">
      <h3>ë§í¬ ì¶”ê°€ / ìˆ˜ì •</h3>
      <form method="post" id="linkForm">
        {% csrf_token %}
        <label for="link_url">URL</label><br>
        <input type="url" id="link_url_input" name="link_url" style="width:100%;" required><br><br>
        <button type="submit">ì €ì¥</button>
        <button type="button" onclick="closeLinkModal()">ë‹«ê¸°</button>
      </form>
    </div>
  </div>

  <hr>
  <h3>ì œì•ˆ ({{ post.proposal_comments.count }})</h3>
  <!-- ì •ë ¬ -->
  {% if request.GET.sort == 'popular' or not request.GET.sort %}
  <strong>ì¸ê¸°ìˆœ</strong>
  {% else %}
  <a href="?sort=popular{% if request.GET.filter == 'petition' %}&filter=petition{% endif %}">ì¸ê¸°ìˆœ</a>
  {% endif %}

  {% if request.GET.sort == 'recent' %}
  <strong>ìµœì‹ ìˆœ</strong>
  {% else %}
  <a href="?sort=recent{% if request.GET.filter == 'petition' %}&filter=petition{% endif %}">ìµœì‹ ìˆœ</a>
  {% endif %}

  <!-- ì²­ì› 24 í•„í„° -->
  <form method="get" style="display:inline;">
    {% if request.GET.sort %}
      <input type="hidden" name="sort" value="{{ request.GET.sort }}">
    {% endif %}
    <label>
      <input type="checkbox" name="filter" value="petition" 
        {% if request.GET.filter == 'petition' %}checked{% endif %}
        onchange="this.form.submit()">
      ì²­ì› 24ì— ì˜¬ë¼ê°„ ì œì•ˆ
    </label>
  </form>

  {% for comment in comments %}
  <div id="comment_{{ comment.id }}" style="border-top:1px solid #000; padding:10px 0;">
    <div>
      {% if comment.link_url %}
      <span style="background-color: #a57bff;">êµ­ë¯¼ì²­ì›ë“±ë¡</span>
      {% endif %}
      {% if comment.is_best %}
      <span style="background-color: gray">Best</span>
      {% endif %}
    </div>
    <!-- ì œì•ˆ ì‘ì„±ìì˜ ì•„ì´ë””ëŠ” ë„ìš°ì§€ ì•ŠìŒ -->
    <p><strong>{{ comment.title }}</strong></p>
    <p><b>í˜„í™© ë° ë¬¸ì œì :</b> {{ comment.problem }}</p>
    <p><b>ê°œì„  ë°©ì•ˆ:</b> {{ comment.solution }}</p>
    <p><b>ê¸°ëŒ€ íš¨ê³¼:</b> {{ comment.effect }}</p>
    {% if request.user == comment.user %}
      <!-- <button
        onclick="openEditCommentModal('{{ comment.title|escapejs }}', '{{ comment.problem|escapejs }}', '{{ comment.solution|escapejs }}', '{{ comment.effect|escapejs }}', '{% url 'proposals:detail_comment_update' post.id comment.id %}')">ìˆ˜ì •</button> -->

      <form method="post" action="{% url 'proposals:detail_comment_delete' post.id comment.id %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" onclick="return confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</button>
      </form>

      {% if comment.link_url %}
      <button
        onclick="openLinkModal('{{ comment.link_url }}', '{% url 'proposals:detail_comment_link' post.id comment.id %}')">ë§í¬í¸ì§‘</button>
      {% else %}
      <button onclick="openLinkModal('', '{% url 'proposals:detail_comment_link' post.id comment.id %}')">ë§í¬ì¶”ê°€</button>
      {% endif %}

    {% else %}
    <button>ì‹ ê³ í•˜ê¸°</button>
    {% endif %}

    <p>
      {{ comment.created_at|date:"Y.m.d" }}
      <button onclick="toggleReply({{ comment.id }})">
        ğŸ’¬ ëŒ€ëŒ“ê¸€ ({{ comment.proposal_replies.count }})
      </button>
      <a href="{% url 'proposals:detail_comment_like' post.id comment.id %}">â¤ï¸ {{ comment.liked.count }}</a>
      {% if comment.link_url %}
      <a href="{{ comment.link_url }}" target="_blank">ì²­ì›24ë°”ë¡œê°€ê¸°</a>
      {% endif %}
    </p>

    {% if comment.id == opened_reply_comment_id %}
    <div id="reply-section-{{ comment.id }}" style="display:block;">
    {% else %}
    <div id="reply-section-{{ comment.id }}" style="display:none;">
    {% endif %}
      {% for reply in comment.proposal_replies.all %}
        <div id="reply_{{ reply.id }}">
          <strong>
            {% if reply.user == comment.user %}
              ê¸€ì“´ì´
            {% else %}
              {{ reply.anonymous_name }}
            {% endif %}
          </strong>
          <!-- ì„±ë³„ ì¶œë ¥ ì¶”ê°€ -->
          <small>{% if reply.user.sex == 'M' %}(ë‚¨ì„±){% elif reply.user.sex == 'F' %}(ì—¬ì„±){% else %}(ê¸°íƒ€){% endif %}</small>:
          {% if editing_reply_id == reply.id %}
          <!-- <form method="post" action="{% url 'proposals:detail_reply_update' post.id comment.id reply.id %}">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="reply_update">
            <textarea name="content" style="width:100%; height:60px;">{{ reply.content }}</textarea><br>
            <button type="submit">ìˆ˜ì • ì™„ë£Œ</button>
            <a href="{% url 'proposals:detail' post.id %}?open_reply={{ comment.id }}">ì·¨ì†Œ</a>
          </form> -->
          {% else %}
            <p>{{ reply.content }}</p>
            <small>{{ reply.created_at|date:"Y.m.d" }}</small>
            <a href="{% url 'proposals:detail_reply_like' post.id comment.id reply.id %}">â¤ï¸ {{ reply.liked.count }}</a>
            {% if request.user == reply.user %}
            <!-- <a
              href="{% url 'proposals:detail' post.id %}?edit_reply={{ reply.id }}&open_reply={{ comment.id }}#reply_{{ reply.id }}">ìˆ˜ì •</a> -->
            <form method="post" action="{% url 'proposals:detail_reply_delete' post.id comment.id reply.id %}"
              style="display:inline;">
              {% csrf_token %}
              <button type="submit" onclick="return confirm('ëŒ€ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</button>
            </form>
            {% else %}
            <button>ì‹ ê³ í•˜ê¸°</button>
            {% endif %}
          {% endif %}
        </div>
      {% empty %}
      <p>ëŒ€ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      {% endfor %}

        <form method="post" action="{% url 'proposals:detail_reply_create' post.id comment.id %}">
          {% csrf_token %}
          <textarea name="content" placeholder="ëŒ€ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." style="width:100%; height:60px;"></textarea><br>
          <button type="submit">ë“±ë¡</button>
        </form>
      </div>
    </div>
  {% empty %}
  <p>ì•„ì§ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
  {% endfor %}

    <h3>ê´€ë ¨ ì•„í‹°í´</h3>
    {% if post.community_post.related_article %}
    <a href="{% url 'articles:detail' post.community_post.related_article.id %}" class="card-link">
      <div class="card">
        <div class="article-thumbnail">
          <img src="{{ post.community_post.related_article.image.url }}" alt="ì¸ë„¤ì¼" style="width: 100%;">
        </div>
        <div class="card-content">
          {{ post.community_post.related_article.title|truncatechars:30 }}
        </div>
        <div class="meta">
          â¤ï¸ {{ post.community_post.related_article.liked.count }} | ğŸ’¬ {{ post.community_post.related_article.article_comments.count }}
        </div>
      </div>
    </a>
    {% else %}
    <p style="color: #999;">ì´ ì œì•ˆê³¼ ì—°ê²°ëœ ì•„í‹°í´ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}

    <hr>

    <h3>ì¶”ì²œ ì•„í‹°í´</h3>
    <section class="grid">
      {% for article in recommended_articles %}
      <a href="{% url 'articles:detail' article.id %}" class="card-link">
        <div class="card">
          <div class="article-thumbnail">
            <img src="{{ article.image }}" alt="ì¸ë„¤ì¼" style="width: 100%;">
          </div>
          <div class="card-content">
            {{ article.title|truncatechars:30 }}
          </div>
          <div class="meta">
            â¤ï¸ {{ article.liked.count }} | ğŸ’¬ {{ article.article_comments.count }}
          </div>
        </div>
      </a>
      {% empty %}
      <p style="color: #999;">ì¶”ì²œ ì•„í‹°í´ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      {% endfor %}
    </section>

    <script>
      function toggleReply(commentId) {
        const el = document.getElementById('reply-section-' + commentId);
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
      }
      function openProposalModal() {
        document.getElementById('proposalModal').classList.add('show');
      }
      function closeProposalModal() {
        document.getElementById('proposalModal').classList.remove('show');
      }
      function openEditCommentModal(title, problem, solution, effect, actionUrl) {
        document.getElementById('editCommentTitle').value = title;
        document.getElementById('editCommentProblem').value = problem;
        document.getElementById('editCommentSolution').value = solution;
        document.getElementById('editCommentEffect').value = effect;
        document.getElementById('editCommentForm').action = actionUrl;
        document.getElementById('editCommentModal').classList.add('show');
      }
      function closeEditModal() {
        document.getElementById('editCommentModal').classList.remove('show');
      }

      function openLinkModal(currentUrl, actionUrl) {
        document.getElementById("link_url_input").value = currentUrl || "";
        document.getElementById("linkForm").action = actionUrl;
        document.getElementById("linkModal").classList.add("show");
      }

      function closeLinkModal() {
        document.getElementById("linkModal").classList.remove("show");
      }

      function copyCurrentUrl() {
        const url = window.location.href;
        navigator.clipboard.writeText(url);
        alert("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
      }
    </script>

</body>

</html>