<!DOCTYPE html>
{% load static %}
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{{ post.title }} - ë” ì»¤ë®¤ë‹ˆí‹°</title>

    <style>
        .grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
          gap: 1.5rem;
        }

        .card {
          background-color: #1f1f1f;
          padding: 1rem;
          border-radius: 10px;
          color: white;
          transition: transform 0.2s ease;
        }

        .article-thumbnail {
          width: 120px;
          height: 120px;
          border-radius: 8px;
          background-color: #ccc;
          object-fit: cover;
        }
    </style>
</head>
<body>

{% if messages %}
  <div>
    {% for message in messages %}
      <p style="color:red;">{{ message }}</p>
    {% endfor %}
  </div>
{% endif %}

<a href="{% url 'community:home' %}">â† ì»¤ë®¤ë‹ˆí‹° í™ˆìœ¼ë¡œ</a>

<form id="voteForm" method="post" action="{% url 'community:detail_vote' post.id %}">
  {% csrf_token %}
  <label>
    <input type="radio" name="selected" value="1"
           {% if voted_choice == 1 %}checked{% endif %}
           {% if voted_choice %}disabled{% endif %}
           onchange="this.form.submit()"> {{ post.option1 }}
  </label><br>

  <label>
    <input type="radio" name="selected" value="2"
           {% if voted_choice == 2 %}checked{% endif %}
           {% if voted_choice %}disabled{% endif %}
           onchange="this.form.submit()"> {{ post.option2 }}
  </label><br>

  <label>
    <input type="radio" name="selected" value="3"
           {% if voted_choice == 3 %}checked{% endif %}
           {% if voted_choice %}disabled{% endif %}
           onchange="this.form.submit()"> {{ post.option3 }}
  </label><br>
</form>

<hr>
<div style="display:flex; justify-content:space-between; align-items:center;">
  <div>ğŸ’¬ {{ comments.count }}</div>
  <div>
    {% if request.user in post.scrapped.all %}
      <a style="color: #a57bff;" href="{% url 'community:detail_post_scrap' post.id %}">ìŠ¤í¬ë©</a>
    {% else %}
      <a style="color: #000;" href="{% url 'community:detail_post_scrap' post.id %}">ìŠ¤í¬ë©</a>
    {% endif %}
  </div>
  <div><button onclick="copyCurrentUrl()">ê³µìœ </button></div>
</div>
<hr>

<script>
function copyCurrentUrl() {
  const url = window.location.href;
  navigator.clipboard.writeText(url);
  alert("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
}
</script>

<h2>ì˜ê²¬</h2>
{% load extra_dict %}
{% for comment in comments %}
  <div id="comment_{{ comment.id }}" style="border-top:1px solid #000; padding:10px 0;">
    <img src="{{ comment.image }}" width="50" height="50">
    <strong>{{ comment.user.username }}</strong>:

    {% if editing_comment_id == comment.id %}
      <!-- ìˆ˜ì • í¼ ìˆ¨ê¹€ -->
    {% else %}
      <p>{{ comment.content }}</p>
      {% if request.user == comment.user %}
        <!-- ëŒ“ê¸€ ì‚­ì œ í¼ -->
        <form method="post" action="{% url 'community:detail_comment_delete' comment.post.id comment.id %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" onclick="return confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</button>
        </form>
      {% endif %}
    {% endif %}

    <p>
      {{ comment.created_at|date:"Y.m.d" }}
      <button class="toggle-reply-btn" data-comment-id="{{ comment.id }}">
        ğŸ’¬ ë‹µê¸€ ({{ comment.replies.count }})
      </button>
      <a href="{% url 'community:detail_comment_like' post.id comment.id %}">â¤ï¸ {{ comment.liked.count }}</a>
    </p>

    <!-- ë‹µê¸€ ë¦¬ìŠ¤íŠ¸ì™€ ì…ë ¥ í¼ -->
    <div id="reply-section-{{ comment.id }}" style="{% if opened_reply_section == comment.id %}display:block;{% else %}display:none;{% endif %}; margin-left: 20px;">
      {% for reply in replies %}
        {% if reply.comment.id == comment.id %}
          <div id="reply_{{ reply.id }}">
            <img src="{{ reply.image }}" width="40" height="40">
            <strong>{{ reply.user.username }}</strong>:
            <p>{{ reply.content }}</p>

            {% if request.user == reply.user %}
              <form method="post" action="{% url 'community:detail_reply_delete' reply.comment.post.id reply.comment.id reply.id %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" onclick="return confirm('ëŒ€ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</button>
              </form>
            {% endif %}

            <small>{{ reply.created_at|date:"Y.m.d H:i" }}</small>
            <a href="{% url 'community:detail_reply_like' post.id comment.id reply.id %}">â¤ï¸ {{ reply.liked.count }}</a>

            {# AI ì£¼ì„ ë³´ì—¬ì£¼ê¸° #}
            {% with reply_evidence=reply.replyevidence_set.first %}
              {% if reply_evidence %}
                <div style="background:#333; color:#eee; padding:10px; margin-top:10px; border-radius:8px;">
                  <div style="font-weight:bold; margin-bottom:6px;">AI ì£¼ì„</div>
                  <div style="background:#555; padding:10px; border-radius:4px;">
                    {{ reply_evidence.keyword }}<br>
                    <a href="{{ reply_evidence.link1 }}" target="_blank" style="color:#9cf;">ì¶œì²˜ ë§í¬</a>
                  </div>
                </div>
              {% endif %}
            {% endwith %}
          </div>
        {% endif %}
      {% empty %}
        <p>ëŒ€ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      {% endfor %}

      <form method="post" id="reply-form-{{ comment.id }}" action="{% url 'community:detail_reply_create' post.id comment.id %}">
        {% csrf_token %}
        <textarea name="content" placeholder="ëŒ€ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." style="width:100%; height:60px;"></textarea><br>
        <button type="submit">ë“±ë¡</button>
        <button type="button" class="reply-ai-button" data-comment-id="{{ comment.id }}">AI</button>
      </form>
    </div>
  </div>
{% empty %}
  <p>ì•„ì§ ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.</p>
{% endfor %}

<h3>ëŒ“ê¸€ ì‘ì„±</h3>
<form method="post" id="comment-form" action="{% url 'community:detail_comment_create' post.id %}">
  {% csrf_token %}
  {{ comment_form.content }}

  <button type="submit" id="submit-comment">ëŒ“ê¸€ ì‘ì„±</button>
  <button type="button" id="ai-button">AI</button>
</form>

{% if commentEvidence %}
  <div id="aiResult" style="background:#333; color:#eee; padding:10px; margin-top:10px; border-radius:8px;">
    <div style="font-weight:bold; margin-bottom:6px;">result</div>
    <div style="background:#555; padding:10px; border-radius:4px;">
      ìë£Œ ê²€ìƒ‰ ê²°ê³¼<br>
      AI ì£¼ì„<br>
      {{ commentEvidence.keyword }}<br>
      <a href="{{ commentEvidence.link1 }}" target="_blank" style="color:#9cf;">ì¶œì²˜ ë§í¬</a>
      <a href="{{ commentEvidence.link2 }}" target="_blank" style="color:#9cf;">ì¶œì²˜ ë§í¬</a>
    </div>
  </div>
{% endif %}

<h3>ê´€ë ¨ ì•„í‹°í´</h3>
{% if post.related_article %}
  <a href="{% url 'articles:detail' post.related_article.id %}" class="card-link">
    <div class="card">
      <div class="article-thumbnail">
        <img src="{{ post.related_article.image.url }}" alt="ì¸ë„¤ì¼" style="width: 100%;">
      </div>
      <div class="card-content">
        {{ post.related_article.title|truncatechars:30 }}
      </div>
      <div class="meta">
        â¤ï¸ {{ post.related_article.liked.count }} | ğŸ’¬ {{ post.related_article.article_comments.count }}
      </div>
    </div>
  </a>
{% else %}
  <p style="color: #999;">ì´ ê²Œì‹œê¸€ê³¼ ì—°ê²°ëœ ì•„í‹°í´ì´ ì—†ìŠµë‹ˆë‹¤.</p>
{% endif %}

<hr>

<h3>ì¶”ì²œ ì•„í‹°í´</h3>
<section class="grid">
  {% for article in recommended_articles %}
    <a href="{% url 'articles:detail' article.id %}" class="card-link">
      <div class="card">
        <div class="article-thumbnail">
          <img src="{{ article.image }}" alt="ì¸ë„¤ì¼" style="width: 100%;">
        </div>
        <div class="card-content">
          {{ article.title|truncatechars:30 }}
        </div>
        <div class="meta">
          â¤ï¸ {{ article.liked.count }} | ğŸ’¬ {{ article.article_comments.count }}
        </div>
      </div>
    </a>
  {% empty %}
    <p style="color: #999;">ì¶”ì²œ ì•„í‹°í´ì´ ì—†ìŠµë‹ˆë‹¤.</p>
  {% endfor %}
</section>
<a href="{% url 'community:detail_comment_detail' post.id %}">ëŒ“ê¸€ ìƒì„¸</a>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // ëŒ“ê¸€ AI ë²„íŠ¼
  const aiBtn = document.getElementById('ai-button');
  aiBtn.addEventListener('click', function() {
    const form = document.getElementById('comment-form');
    form.action = "{% url 'community:detail_comment_ai_response' post.id %}";
    form.submit();
    form.action = "{% url 'community:detail_comment_create' post.id %}"; // ë‹¤ì‹œ ì›ë³µ
  });

  // ë‹µê¸€ AI ë²„íŠ¼ë“¤ ì´ë²¤íŠ¸ ë°”ì¸ë”©
  const replyAiButtons = document.querySelectorAll('.reply-ai-button');
  replyAiButtons.forEach(button => {
    button.addEventListener('click', function() {
      const commentId = this.dataset.commentId;
      const form = document.getElementById('reply-form-' + commentId);
      form.action = "{% url 'community:detail_reply_ai_r_
