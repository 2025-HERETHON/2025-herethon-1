{% load extra_dict %}
{% for comment in comments %}
  <div id="comment_{{ comment.id }}" style="border-top:1px solid #000; padding:10px 0;">
    <img src="{{ comment.image }}" width="50" height="50">
    <strong>{{ comment.anonymous_name }}</strong>:


      <p>{{ comment.content }}</p>
      {% if request.user == comment.user %}
    <form method="post" action="{% url 'community:detail_comment_delete' post.id comment.id now %}" style="display:inline;">
  {% csrf_token %}
  <button type="submit" onclick="return confirm('댓글을 삭제하시겠습니까?');">삭제</button>
</form>
        💬 답글 ({{ comment.replies.count }})
      </button>

    {% endif %}

    <p>
      {{ comment.created_at|date:"Y.m.d" }}
      <button onclick="toggleReply({{ comment.id }})">
        💬 답글 ({{ comment.replies.count }})
      </button>
      {% if request.user in comment.liked.all %}
      <a style="color: #a57bff" href="{% url 'community:detail_comment_like' post.id comment.id now %}">
        ❤️ {{ comment.liked.count }}
      </a>
      {% else %}
      <a style="color: #fff" href="{% url 'community:detail_comment_like' post.id comment.id now %}">❤️ {{ comment.liked.count }} </a>
      {% endif %}
    </p>


    {% if opened_reply_comment_id|stringformat:"s" == comment.id|stringformat:"s" %}
  <div id="reply-section-{{ comment.id }}" style="display:block;">
{% else %}
  <div id="reply-section-{{ comment.id }}" style="display:none;">
{% endif %}

{% for reply in comment.replies.all %}
      {% if reply.created_at %}
        <img src="{{ reply.image }}" width="50" height="50">
        <div id="reply_{{ reply.id }}">
          <strong>{{ reply.anonymous_name }}</strong>
          <small>
            {% if reply.user.sex == 'M' %}(남성)
            {% elif reply.user.sex == 'F' %}(여성)
            {% else %}(기타)
            {% endif %}
          </small>:

          {% if editing_reply_id == reply.id %}
            {# 수정 중인 답글 UI #}
          {% else %}
            <p>{{ reply.content }}</p>
            {% if request.user == reply.user %}
              <form method="post" action="{% url 'community:detail_reply_delete' reply.comment.post.id reply.comment.id reply.id %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" onclick="return confirm('대댓글을 삭제하시겠습니까?');">삭제</button>
              </form>
            {% else %}
              <button>신고하기</button>
            {% endif %}
          {% endif %}

          <small>{{ reply.created_at|date:"Y.m.d" }}</small>
          <a href="{% url 'community:detail_reply_like' reply.comment.post.id reply.comment.id reply.id %}">좋아요{{reply.liked.count}}</a>
        </div>
      {% endif %}
    {% empty %}
      <p>대댓글이 없습니다.</p>
{% endfor %}

<form method="post" id="reply-form-{{ comment.id }}" action="{% url 'community:detail_reply_create' post.id comment.id %}">
  {% csrf_token %}

  <!-- 필터 값과 열린 답글 comment_id 같이 넘기기 -->
  <input type="hidden" name="filter" value="{{ request.GET.filter|default:'all' }}">
  <input type="hidden" name="opened_reply_comment_id" value="{{ comment.id }}">

  {% if opened_reply_comment_id|stringformat:"s" == comment.id|stringformat:"s" %}
    {{ reply_form.content }}
  {% else %}
    <textarea name="content" placeholder="대댓글을 입력하세요..." style="width:100%; height:60px;">{{ reply_form.content.value|default_if_none:'' }}</textarea>
  {% endif %}
  <br>
  <button type="submit">등록</button>
  <button type="button" id="ai-button-reply-{{ comment.id }}">AI</button>
</form>
</div>
    <script>
      document.getElementById('ai-button-reply-{{ comment.id }}').addEventListener('click', function() {
        const form = document.getElementById('reply-form-{{ comment.id }}');
        form.action = "{% url 'community:detail_reply_ai_response' post.id comment.id %}";
        form.submit();
        form.action = "{% url 'community:detail_reply_create' post.id comment.id %}";
      });

      function toggleReply(commentId) {
    const el = document.getElementById('reply-section-' + commentId);
    if (el.style.display === 'block') {
      el.style.display = 'none';
    } else {
      el.style.display = 'block';
    }
  }
    </script>
     {% if replyEvidenceMap|dict_get1:comment.id %}
      <div class="ai-evidence-section" style="background:#333; color:#eee; padding:10px; margin-top:10px; border-radius:8px;">
        <strong>AI 주석들:</strong><br>
        {% for evidence in replyEvidenceMap|dict_get:comment.id %}
          <div style="background:#555; padding:10px; border-radius:4px; margin-bottom:6px;">
            키워드: {{ evidence.keyword }}<br>
            <a href="{{ evidence.link1 }}" target="_blank" style="color:#9cf;">출처1</a>
            <a href="{{ evidence.link2 }}" target="_blank" style="color:#9cf;">출처2</a>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
{% empty %}
  <p>아직 의견이 없습니다.</p>
{% endfor %}
