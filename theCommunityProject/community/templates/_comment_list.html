{% load extra_dict %}
{% for comment in comments %}
  <div id="comment_{{ comment.id }}" style="border-top:1px solid #000; padding:10px 0;">
    <img src="{{ comment.image }}" width="50" height="50">
    <strong>{{ comment.anonymous_name }}</strong>:

    {% if editing_comment_id == comment.id %}
      {# ìˆ˜ì • ì¤‘ì¸ ëŒ“ê¸€ UI ì‘ì„± #}
    {% else %}
      <p>{{ comment.content }}</p>
      {% if request.user == comment.user %}
        {# ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ë“± #}
      {% endif %}
    {% endif %}

    <p>
      {{ comment.created_at|date:"Y.m.d" }}
      <button onclick="toggleReply({{ comment.id }})">
        ğŸ’¬ ë‹µê¸€ ({{ comment.replies.count }})
      </button>
      <a href="{% url 'community:detail_comment_like' post.id comment.id now %}">
        â¤ï¸ {{ comment.liked.count }}
      </a>
    </p>

    {% if opened_reply_comment_id == comment.id %}
      <div id="reply-section-{{ comment.id }}" style="display:block;">
    {% else %}
      <div id="reply-section-{{ comment.id }}" style="display:none;">
    {% endif %}

    {% for reply in comment.replies.all %}
      {% if reply.created_at %}
        <img src="{{ reply.image }}" width="50" height="50">
        <div id="reply_{{ reply.id }}">
          <strong>{{ reply.anonymous_name }}</strong>
          <small>
            {% if reply.user.sex == 'M' %}(ë‚¨ì„±)
            {% elif reply.user.sex == 'F' %}(ì—¬ì„±)
            {% else %}(ê¸°íƒ€)
            {% endif %}
          </small>:

          {% if editing_reply_id == reply.id %}
            {# ìˆ˜ì • ì¤‘ì¸ ë‹µê¸€ UI #}
          {% else %}
            <p>{{ reply.content }}</p>
            {% if request.user == reply.user %}
              <form method="post" action="{% url 'community:detail_reply_delete' reply.comment.post.id reply.comment.id reply.id %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" onclick="return confirm('ëŒ€ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</button>
              </form>
            {% else %}
              <button>ì‹ ê³ í•˜ê¸°</button>
            {% endif %}
          {% endif %}

          <small>{{ reply.created_at|date:"Y.m.d" }}</small>
          <a href="{% url 'community:detail_reply_like' reply.comment.post.id reply.comment.id reply.id %}">ì¢‹ì•„ìš”</a>
        </div>
      {% endif %}
    {% empty %}
      <p>ëŒ€ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endfor %}

    <form method="post" id="reply-form-{{ comment.id }}" action="{% url 'community:detail_reply_create' post.id comment.id %}">
      {% csrf_token %}
      {% if opened_reply_comment_id == comment.id %}
      {{ reply_form.content }}
      {% else %}
      <textarea name="content" placeholder="ëŒ€ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." style="width:100%; height:60px;">{{ reply_form.content.value|default_if_none:'' }}</textarea>
      {% endif %}
      <br>
      <button type="submit">ë“±ë¡</button>
      <button type="button" id="ai-button-reply-{{ comment.id }}">AI</button>
    </form>

    <script>
      document.getElementById('ai-button-reply-{{ comment.id }}').addEventListener('click', function() {
        const form = document.getElementById('reply-form-{{ comment.id }}');
        form.action = "{% url 'community:detail_reply_ai_response' post.id comment.id %}";
        form.submit();
        form.action = "{% url 'community:detail_reply_create' post.id comment.id %}";
      });

      function toggleReply(commentId) {
    const el = document.getElementById('reply-section-' + commentId);
    if (el.style.display === 'block') {
      el.style.display = 'none';
    } else {
      el.style.display = 'block';
    }
  }
    </script>
    {% if replyEvidenceMap %}
          {% with replyEvidence=replyEvidenceMap|dict_get:comment.id %}
    {% if replyEvidence %}
      <div id="aiResultR" style="background:#333; color:#eee; padding:10px; margin-top:10px; border-radius:8px;">
        <div style="font-weight:bold; margin-bottom:6px;">result</div>
        <div style="background:#555; padding:10px; border-radius:4px;">
          ìë£Œ ê²€ìƒ‰ ê²°ê³¼<br>
          AI ì£¼ì„<br>
          {{ replyEvidence.keyword }}<br>
          <a href="{{ replyEvidence.link1 }}" target="_blank" style="color:#9cf;">ì¶œì²˜ ë§í¬</a>
          <a href="{{ replyEvidence.link2 }}" target="_blank" style="color:#9cf;">ì¶œì²˜ ë§í¬</a>
        </div>
      </div>
    {% endif %}
    {% endwith %}
    {% endif %}
  </div>
{% empty %}
  <p>ì•„ì§ ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.</p>
{% endfor %}
      </div></div>
